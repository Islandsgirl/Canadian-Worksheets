<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canadian Worksheets</title>
  <style>
    :root{
      --bg:#f8f9fa;--card:#fff;--text:#2c3e50;--muted:#666;--border:#ccd2d9;--accent:#2d7ff9;--ok:#27ae60;--warn:#ff8c00
    }
    *{box-sizing:border-box}
    body {font-family: Arial, sans-serif;margin: 2rem;background-color: var(--bg);color:var(--text)}
    h1 {color: var(--text);margin:0 0 1rem}
    h2 {margin-top: 2rem}
    label, select, input, button, textarea {display: block;margin-top: .6rem;font-size: 1rem}
    textarea{width:100%;min-height:70px}
    .section {padding: 1.25rem;background: var(--card);border: 1px solid var(--border);margin-bottom: 2rem;border-radius:8px}
    .row{display:flex;flex-wrap:wrap;gap:1rem}
    .col{min-width:220px;flex:1}
    .controls-inline {display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin-top:.6rem}
    .btn{background:var(--accent);color:#fff;border:0;padding:.6rem .9rem;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#6c757d}
    .btn.success{background:var(--ok)}
    .btn.ghost{background:#e9eef9;color:#1b3b88}
    .muted{color:var(--muted);font-size:.9rem}

    /* Category cards */
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid var(--border);padding:1rem;border-radius:8px}
    .card h3{margin:.2rem 0 .4rem}
    .pill{display:inline-block;background:#eef;border:1px solid #99a;padding:.1rem .45rem;border-radius:999px;font-size:.85rem;margin:.1rem .25rem 0 0;cursor:pointer}

    /* Worksheet rendering */
    .worksheet-preview {margin-top: 2rem}
    .ack{border:1px dashed #9bb3ff;background:#f4f7ff;padding:10px;border-radius:8px;margin:0 0 1rem 0}
    .page{page-break-after:always;border:1px solid var(--border);background:#fff;margin:0 0 1.25rem;padding:1rem;border-radius:8px}
    .page:last-child{page-break-after:auto}
    .worksheet-header {display:flex;justify-content:space-between;margin-bottom: .75rem;border-bottom:1px solid var(--border);padding-bottom:.5rem}
    .worksheet-grid {display: grid;grid-template-columns: repeat(3, 1fr);gap: .9rem;font-size: 1.12rem}
    .problem{min-height:2.4rem;border-bottom:1px dashed #ddd;padding:.2rem .25rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .decor{opacity:.95;font-size:1.1rem}
    .thumb{height:24px;width:24px;object-fit:cover;border-radius:4px;border:1px solid #ddd}
    .answer-key{margin-top:1rem;border-top:2px solid #999;padding-top:.75rem}
    .example{border:1px solid #d3e2ff;background:#f0f6ff;border-radius:8px;padding:.75rem;margin:.5rem 0 1rem}
    .example h4{margin:.1rem 0 .4rem;font-size:1.05rem}
    .tag{display:inline-block;background:#eef;border:1px solid #99a;padding:.05rem .45rem;border-radius:999px;font-size:.8rem;margin-right:.35rem}

    footer {margin-top: 3rem;font-size: 0.9rem;color: var(--muted)}
  </style>
</head>
<body>
  <h1>üåê Canadian Worksheet Generator</h1>

  <!-- LANGUAGE ARTS -->
  <div class="section">
    <h2>üìö Language Arts</h2>
    <p class="muted">Short, student-friendly news with multi-level activities.</p>
    <div class="controls-inline">
      <a class="btn secondary" href="reading.html">Open Reading Comprehension</a>
    </div>
  </div>

  <!-- MATH LANDING -->
  <div class="section">
    <h2>‚ûó Math: Choose a Section</h2>
    <div class="grid-cards">
      <div class="card">
        <h3>Basic Operations</h3>
        <div>
          <button class="pill" data-type="add">Addition</button>
          <button class="pill" data-type="sub">Subtraction</button>
          <button class="pill" data-type="mul">Multiplication</button>
          <button class="pill" data-type="div">Division</button>
        </div>
      </div>
      <div class="card">
        <h3>Measurement</h3>
        <div>
          <button class="pill" data-type="measure">Metric Conversions</button>
          <button class="pill" data-type="time">Telling Time</button>
          <button class="pill" data-type="thermo">Thermometers</button>
        </div>
      </div>
      <div class="card">
        <h3>Money & Life Skills</h3>
        <div>
          <button class="pill" data-type="money">Money / Currency</button>
          <button class="pill" data-type="receipts">Add Receipts</button>
          <button class="pill" data-type="percent">Percent & Discounts</button>
        </div>
      </div>
      <div class="card">
        <h3>Word Problems</h3>
        <div>
          <button class="pill" data-type="word">Simplified Word Problems</button>
        </div>
      </div>
    </div>
    <p class="muted" style="margin-top:.6rem">Tip: Pick a section above to auto-select options below.</p>
  </div>

  <!-- MATH OPTIONS -->
  <div class="section" id="mathSection">
    <h2 id="mathHeading">Worksheet Options</h2>
    <div class="row">
      <div class="col">
        <label for="mathType">Math type</label>
        <select id="mathType">
          <option value="add">Addition</option>
          <option value="sub">Subtraction</option>
          <option value="mul">Multiplication</option>
          <option value="div">Division</option>
          <option value="money">Money / Currency</option>
          <option value="measure">Measurement (metric)</option>
          <option value="time">Telling Time</option>
          <option value="thermo">Thermometer Reading</option>
          <option value="receipts">Add Receipts</option>
          <option value="percent">Percent Problems</option>
          <option value="word">Word Problems (simplified)</option>
        </select>
      </div>
      <div class="col" id="numRanges">
        <label for="rangeA">Number range A (min‚Äìmax)</label>
        <input id="rangeA" type="text" value="0-20" placeholder="e.g., 0-20" />
        <span class="muted">Used by +, ‚àí, √ó, √∑</span>
        <label for="rangeB">Number range B (min‚Äìmax)</label>
        <input id="rangeB" type="text" value="0-20" placeholder="e.g., 0-20" />
      </div>
      <div class="col">
        <label for="pages">Pages</label>
        <input id="pages" type="number" min="1" max="20" value="1" />
      </div>
      <div class="col">
        <label for="perPage">Problems per page</label>
        <input id="perPage" type="number" min="6" max="60" value="24" />
      </div>
      <div class="col">
        <label for="layoutMode">Layout</label>
        <select id="layoutMode">
          <option value="3">Horizontal (3 columns)</option>
          <option value="2">2 columns</option>
          <option value="1">Vertical (1 column)</option>
        </select>
      </div>
    </div>

    <!-- MONEY OPTIONS -->
    <div class="row" id="moneyRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="CAD">CAD ‚Äì $ (Canadian)</option>
          <option value="USD">USD ‚Äì $ (United States)</option>
          <option value="EUR">EUR ‚Äì ‚Ç¨ (Euro)</option>
          <option value="GBP">GBP ‚Äì ¬£ (Pound)</option>
          <option value="JPY">JPY ‚Äì ¬• (Yen)</option>
        </select>
      </div>
      <div class="col">
        <label for="moneyMode">Money problem type</label>
        <select id="moneyMode">
          <option value="sum">Count the total value</option>
          <option value="make">Make this amount</option>
          <option value="change">Change from amount</option>
        </select>
      </div>
      <div class="col">
        <label for="moneySumStyle">If "Count the total" ‚Üí style</label>
        <select id="moneySumStyle">
          <option value="target">Show a target amount (students write coins/bills)</option>
          <option value="coins" selected>Show a list of coins/bills (students write the total)</option>
        </select>
      </div>
      <div class="col" id="billCol" style="display:none;">
        <label for="billGiven">Bill given (for Change)</label>
        <select id="billGiven"></select>
      </div>
    </div>

    <!-- WORD PROBLEM OPTIONS (clean, single block) -->
    <div class="row" id="wordRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="wpLevel">Reading level</label>
        <select id="wpLevel">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>

        <label for="wpEmoji">Emoji support</label>
        <select id="wpEmoji">
          <option value="many">Many üòä</option>
          <option value="some" selected>Some üôÇ</option>
          <option value="none">None</option>
        </select>

        <label><input type="checkbox" id="wpLocalLangToggle"/> Render worksheet in local language (beta)</label>
        <span class="muted">Uses a placeholder translator. We‚Äôll swap in FirstVoices later.</span>
      </div>

      <div class="col">
        <label for="wpTown">Town / City</label>
        <input id="wpTown" type="text" placeholder="e.g., Port Hardy" />
        <label for="wpProvince">Province / State</label>
        <input id="wpProvince" type="text" value="BC" />
        <label for="wpCountry">Country</label>
        <input id="wpCountry" type="text" value="Canada" />
      </div>

      <div class="col">
        <label for="wpNationSelect">Nation / Territory (BC)</label>
        <select id="wpNationSelect"></select>

        <label for="wpLang">Local language (auto)</label>
        <input id="wpLang" type="text" placeholder="auto" />

        <label for="wpPhrases">Phrases (auto; editable)</label>
        <textarea id="wpPhrases" placeholder="Hello / Thank you, etc."></textarea>

        <label><input type="checkbox" id="wpAckToggle" checked/> Include territorial acknowledgement</label>
      </div>
    </div>

    <!-- TIME OPTIONS -->
    <div class="row" id="timeRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="timeFormat">Time format</label>
        <select id="timeFormat">
          <option value="digital">Digital (HH:MM)</option>
          <option value="analog">Analog (describe clock)</option>
        </select>
      </div>
      <div class="col">
        <label for="timeStep">Minute steps</label>
        <select id="timeStep">
          <option value="5">5 minutes</option>
          <option value="1">1 minute</option>
          <option value="15">15 minutes</option>
        </select>
      </div>
      <div class="col">
        <label for="timeSystem">Clock</label>
        <select id="timeSystem">
          <option value="12">12-hour</option>
          <option value="24">24-hour</option>
        </select>
      </div>
    </div>

    <!-- THERMOMETER OPTIONS -->
    <div class="row" id="thermoRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="tempScale">Temperature scale</label>
        <select id="tempScale">
          <option value="C">Celsius (¬∞C)</option>
          <option value="F">Fahrenheit (¬∞F)</option>
        </select>
      </div>
    </div>

    <!-- RECEIPTS OPTIONS -->
    <div class="row" id="receiptsRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="itemsCount">Items per receipt</label>
        <input id="itemsCount" type="number" min="2" max="8" value="4" />
      </div>
      <div class="col">
        <label for="provinceSelect">Province / Territory (auto-fill tax)</label>
        <select id="provinceSelect">
          <option value="BC" selected>BC</option>
          <option value="AB">AB</option>
          <option value="SK">SK</option>
          <option value="MB">MB</option>
          <option value="ON">ON</option>
          <option value="QC">QC</option>
          <option value="NB">NB</option>
          <option value="NL">NL</option>
          <option value="NS">NS</option>
          <option value="PE">PE</option>
          <option value="YT">YT</option>
          <option value="NT">NT</option>
          <option value="NU">NU</option>
        </select>
        <span class="muted">Auto-fills PST/QST/RST and GST/HST</span>
      </div>
      <div class="col">
        <label for="pstPct">Provincial tax % (PST/QST/RST)</label>
        <input id="pstPct" type="number" min="0" max="15" value="7" />
      </div>
      <div class="col">
        <label for="gstPct">Federal tax % (GST/HST)</label>
        <input id="gstPct" type="number" min="0" max="20" value="5" />
      </div>
    </div>

    <!-- PERCENT OPTIONS -->
    <div class="row" id="percentRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="percentKind">Percent scenario</label>
        <select id="percentKind">
          <option value="discount">Store discount</option>
          <option value="tip">Restaurant tip</option>
          <option value="tax">Sales tax</option>
          <option value="change">Increase / Decrease</option>
        </select>
      </div>
    </div>

    <!-- DECOR OPTIONS -->
    <div class="row" style="margin-top:.5rem;">
      <div class="col">
        <label for="emojiTheme">Emoji theme (decorations)</label>
        <select id="emojiTheme">
          <option value="none">None</option>
          <option value="animals">Animals üêæ</option>
          <option value="space">Space üöÄ</option>
          <option value="sports">Sports üèà</option>
          <option value="food">Food üçé</option>
        </select>
      </div>
      <div class="col">
        <label for="imageTheme">Image theme (safe)</label>
        <select id="imageTheme">
          <option value="none">None</option>
          <option value="public_domain">Public-domain icons</option>
        </select>
        <span class="muted">Avoid copyrighted characters. Use your own images only if you have rights.</span>
      </div>
      <div class="col">
        <label for="customImg">Custom image URL (optional)</label>
        <input id="customImg" type="text" placeholder="https://‚Ä¶ (must have usage rights)" />
      </div>
    </div>

    <div class="controls-inline">
      <label><input type="checkbox" id="showAnswers"/> Show Answer Key</label>
      <button class="btn" id="btnGenerate">Generate Worksheet</button>
      <button class="btn success" id="btnPrint">Print / Save PDF</button>
      <button class="btn secondary" id="btnSelfTest" title="Run quick checks">Run Self-Test</button>
    </div>
  </div>

  <div class="worksheet-preview" id="worksheet"></div>

  <div id="status" class="section" style="display:none; border-color:#f3c7c7; background:#fff7f7">
    <strong>Status:</strong>
    <pre id="statusText" style="white-space:pre-wrap;margin:.5rem 0 0"></pre>
  </div>

  <footer>
    <h2>Privacy Policy</h2>
    <p>This website may use cookies for basic functionality. We do not collect personally identifiable information unless you choose to provide it. We will never sell your data to third parties.</p>
    <p class="muted">Image use note: Do not upload or embed copyrighted character images unless you own or have permission to use them.</p>
  </footer>

  <script>
    // =========== Helpers ==========
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const parseRange=(s,def=[0,20])=>{const m=(s||"").trim().match(/^(\-?\d+)\s*[-‚Äì]\s*(\-?\d+)$/);if(!m)return def.map(Number);const a=parseInt(m[1],10),b=parseInt(m[2],10);return a<=b?[a,b]:[b,a]};

    const emojiPacks={
      none:[],
      animals:["ü¶ä","üêª","üê±","üê∂","ü¶â","üê∞"],
      space:["üöÄ","üõ∞Ô∏è","ü™ê","üåå","üõ∏","üåü"],
      sports:["‚öΩ","üèÄ","üèà","üéæ","üèí","ü•ã"],
      food:["üçé","üçî","üçï","üç£","üç™","üçâ"]
    };

    const pdThumbs=[
      "https://upload.wikimedia.org/wikipedia/commons/3/3f/Transparent_pixel.png"
    ];

    const receiptEmojis={
      Apples:"üçé", Milk:"ü•õ", Bread:"üçû", Pasta:"üçù", Soup:"üç≤", Bananas:"üçå", Notebook:"üìì", Markers:"üñäÔ∏è", Yogurt:"ü•£", Juice:"üßÉ"
    };

    // --- Starter BC Nations dataset (expand as needed) ---
    const bcNations = [
      { nation: "Kwakwaka‚Äôwakw", lang: "KwakÃìwala", phrases: { hello: "Gilakas‚Äôla", thanks: "Gilakas‚Äôla" } },
      { nation: "Nuu-chah-nulth", lang: "NuuƒçaanÃìu…´ (Nuu-chah-nulth)", phrases: { hello: "ƒåuu", thanks: "ƒçaa îaa (thank you)" } },
      { nation: "Coast Salish (Lekwungen)", lang: "L…ôkÃì ∑…ô≈ãinÃì…ô≈ã (Lekwungen)", phrases: { hello: "H√°w‚Äôaa", thanks: "H√çSWÃ±·∏¥E" } },
      { nation: "Coast Salish (Hul‚Äôq‚Äôumi‚Äônum‚Äô)", lang: "Hul‚Äôq‚Äôumi‚Äônum‚Äô", phrases: { hello: "‚ÄôUy‚Äô skweyul", thanks: "Huy ch q‚Äôu" } },
      { nation: "Tla‚Äôamin Nation", lang: "∆õa îam…©n (Ayajuthem)", phrases: { hello: "ƒç…õƒç…õhaŒ∏…õƒç", thanks: "ƒç…õƒç…õ‚Äôsn…õ" } },
      { nation: "Squamish Nation (S·∏µwxÃ±w√∫7mesh √öxwumixw)", lang: "S·∏µwxÃ±w√∫7mesh sn√≠chim", phrases: { hello: "Chen kw‚Äôenmantumiyap", thanks: "Huy chexw" } },
      { nation: "Tsilhqot‚Äôin Nation", lang: "T≈ùilhqot‚Äôin", phrases: { hello: "Diniyah", thanks: "G√∫ntsi" } }
    ];

    // Canadian tax presets by province/territory
    const caTaxByProvince = {
      AB: { pst: 0, gst: 5 },
      BC: { pst: 7, gst: 5 },
      SK: { pst: 6, gst: 5 },
      MB: { pst: 7, gst: 5 },
      ON: { pst: 0, gst: 13 }, // HST 13
      QC: { pst: 9.975, gst: 5 }, // QST + GST
      NB: { pst: 0, gst: 15 }, // HST 15
      NL: { pst: 0, gst: 15 }, // HST 15
      NS: { pst: 0, gst: 15 }, // HST 15
      PE: { pst: 0, gst: 15 }, // HST 15
      YT: { pst: 0, gst: 5 },
      NT: { pst: 0, gst: 5 },
      NU: { pst: 0, gst: 5 }
    };

    function autofillProvinceTaxes(prov){
      const r = caTaxByProvince[prov];
      if(!r) return;
      document.getElementById('pstPct').value = String(r.pst);
      document.getElementById('gstPct').value = String(r.gst);
    }

    const currencyData={
      CAD:{symbol:"$", code:"CAD", denominations:[100,50,20,10,5,2,1,0.25,0.10,0.05]},
      USD:{symbol:"$", code:"USD", denominations:[100,50,20,10,5,2,1,0.25,0.10,0.05]},
      EUR:{symbol:"‚Ç¨", code:"EUR", denominations:[200,100,50,20,10,5,2,1,0.5,0.2,0.1]},
      GBP:{symbol:"¬£", code:"GBP", denominations:[50,20,10,5,2,1,0.5,0.2,0.1]},
      JPY:{symbol:"¬•", code:"JPY", denominations:[10000,5000,2000,1000,500,100,50,10,5,1]}
    };

    function formatMoney(val, cur){
      if(cur==="JPY") return `¬•${Math.round(val)}`;
      return `${currencyData[cur].symbol}${val.toFixed(2)}`;
    }

    function makeChange(amount, cur){
      const denoms=[...currencyData[cur].denominations].sort((a,b)=>b-a);
      let remaining=amount;const out=[];
      for(const d of denoms){
        let cnt=0;
        if(cur==="JPY"){cnt=Math.floor(remaining/d);remaining-=cnt*d;}
        else {cnt=Math.floor((remaining+1e-6)/d);remaining=+(remaining-cnt*d).toFixed(2);} 
        if(cnt>0) out.push(`${cnt}√ó${(cur==="JPY"? d: formatMoney(d,cur).replace(/^[$‚Ç¨¬£]/,''))}`);
      }
      return out.join(", ");
    }

    function pickDecor(){
      const emTheme=document.getElementById('emojiTheme').value;
      const arr=emojiPacks[emTheme]||[];const em=arr.length?arr[randInt(0,arr.length-1)]:"";
      const imgTheme=document.getElementById('imageTheme').value;
      const custom=document.getElementById('customImg').value.trim();
      let imgSrc="";
      if(custom) imgSrc=custom; else if(imgTheme==='public_domain') imgSrc=pdThumbs[0];
      return {em,imgSrc};
    }

    // =========== Problem generators ==========
    function genArithmetic(op,aRange,bRange){
      const [aMin,aMax]=parseRange(aRange);const [bMin,bMax]=parseRange(bRange);
      const a=randInt(aMin,aMax), b=randInt(bMin,bMax);
      switch(op){
        case 'add': return {q:`${a} + ${b} = ____`, a:(a+b)};
        case 'sub': return {q:`${a} ‚àí ${b} = ____`, a:(a-b)};
        case 'mul': return {q:`${a} √ó ${b} = ____`, a:(a*b)};
        case 'div': {
          const x=randInt(aMin,aMax), y=randInt(Math.max(1,bMin),Math.max(1,bMax));
          return {q:`${x*y} √∑ ${y} = ____`, a:x};
        }
      }
    }

    function genMeasurement(){
      const types=["cm‚Üím","m‚Üícm","g‚Üíkg","kg‚Üíg","mL‚ÜíL","L‚ÜímL"];
      const t=types[randInt(0,types.length-1)];
      switch(t){
        case "cm‚Üím":{const v=randInt(10,5000);return {q:`Convert ${v} cm to m`, a:(v/100).toFixed(2)+" m"}};
        case "m‚Üícm":{const v=randInt(1,500);return {q:`Convert ${v} m to cm`, a:(v*100)+" cm"}};
        case "g‚Üíkg":{const v=randInt(100,50000);return {q:`Convert ${v} g to kg`, a:(v/1000).toFixed(2)+" kg"}};
        case "kg‚Üíg":{const v=randInt(1,200);return {q:`Convert ${v} kg to g`, a:(v*1000)+" g"}};
        case "mL‚ÜíL":{const v=randInt(100,5000);return {q:`Convert ${v} mL to L`, a:(v/1000).toFixed(2)+" L"}};
        case "L‚ÜímL":{const v=randInt(1,10);return {q:`Convert ${v} L to mL`, a:(v*1000)+" mL"}};
      }
    }

    function genTime(){
      const step=parseInt(document.getElementById('timeStep').value)||5;
      const system=document.getElementById('timeSystem').value;
      const fmt=document.getElementById('timeFormat').value;
      const totalMinutes=randInt(0, Math.floor(24*60/step))*step;
      let h=Math.floor(totalMinutes/60), m=totalMinutes%60;
      let label;
      if(system==='12'){
        const ampm=h>=12? 'PM':'AM';
        const hh=((h%12)||12).toString().padStart(2,'0');
        label=`${hh}:${m.toString().padStart(2,'0')} ${ampm}`;
      } else { label=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }
      if(fmt==='digital') return {q:`What time is this? ${label.replace(/\s?(AM|PM)/,'')}`, a:label};
      const hourPos=(h%12)+(m/60);
      const minutePos=m/5;
      return {q:`Analog clock: hour hand near ${Math.round(hourPos)}; minute hand on ${minutePos*5} minutes. What time is it?`, a:label};
    }

    function genThermo(){
      const scale=document.getElementById('tempScale').value;
      const val=(scale==='C')? randInt(-10,40) : randInt(10,105);
      return {q:`Thermometer reads: ${val} ¬∞${scale}. Write the temperature.`, a:`${val}¬∞${scale}`};
    }

    function genReceipts(){
      const cur=document.getElementById('currency').value || 'CAD';
      const items=parseInt(document.getElementById('itemsCount').value)||4;
      const pst=parseFloat(document.getElementById('pstPct').value)||0;
      const gst=parseFloat(document.getElementById('gstPct').value)||0;
      const names=["Apples","Milk","Bread","Pasta","Soup","Bananas","Notebook","Markers","Yogurt","Juice"];

      let sub=0;
      const lines=[];
      for(let i=0;i<items;i++){
        const name=names[randInt(0,names.length-1)];
        const icon=receiptEmojis[name]||'';
        const price=(cur==='JPY'? randInt(50,900) : (randInt(1,120)+randInt(0,99)/100));
        lines.push(`${icon} ${name} ‚Äî ${formatMoney(price,cur)}`);
        sub += price;
      }

      const pstAmt = (cur==='JPY'? Math.round(sub*pst/100) : +(sub*pst/100).toFixed(2));
      const gstAmt = (cur==='JPY'? Math.round(sub*gst/100) : +(sub*gst/100).toFixed(2));
      const taxAmt = (cur==='JPY'? pstAmt+gstAmt : +(pstAmt+gstAmt).toFixed(2));
      const grand  = (cur==='JPY'? Math.round(sub+taxAmt) : +(sub+taxAmt).toFixed(2));

      return {
        q:`üßæ Receipt: ${lines.join('; ')}; PST ${pst}% + GST/HST ${gst}% ‚Üí Total = ____`,
        a:formatMoney(grand,cur)
      };
    }

    function genPercent(){
      const cur=document.getElementById('currency').value || 'CAD';
      const kind=document.getElementById('percentKind').value;
      if(kind==='discount'){
        const price=(cur==='JPY'? randInt(500,6000) : (randInt(5,80)+randInt(0,99)/100));
        const pct=[10,15,20,25,30][randInt(0,4)];
        const disc=(cur==='JPY'? Math.round(price*pct/100) : +(price*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(price-disc) : +(price-disc).toFixed(2));
        return {q:`Store sale: ${pct}% off ${formatMoney(price,cur)} ‚Üí Pay ____`, a:formatMoney(final,cur)};
      } else if(kind==='tip'){
        const bill=(cur==='JPY'? randInt(800,8000) : (randInt(10,120)+randInt(0,99)/100));
        const pct=[10,12,15,18,20][randInt(0,4)];
        const tipAmt=(cur==='JPY'? Math.round(bill*pct/100) : +(bill*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(bill+tipAmt) : +(bill+tipAmt).toFixed(2));
        return {q:`Restaurant bill ${formatMoney(bill,cur)} + tip ${pct}% = ____`, a:formatMoney(final,cur)};
      } else if(kind==='tax'){
        const price=(cur==='JPY'? randInt(300,9000) : (randInt(5,100)+randInt(0,99)/100));
        const pct=[5,8,10,12][randInt(0,3)];
        const taxAmt=(cur==='JPY'? Math.round(price*pct/100) : +(price*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(price+taxAmt) : +(price+taxAmt).toFixed(2));
        return {q:`Item ${formatMoney(price,cur)} + tax ${pct}% = ____`, a:formatMoney(final,cur)};
      } else {
        const base=(cur==='JPY'? randInt(500,5000) : (randInt(10,200)+randInt(0,99)/100));
        const pct=[5,10,20,25,30][randInt(0,4)];
        const dir=Math.random()<0.5? 'increase':'decrease';
        const delta=(cur==='JPY'? Math.round(base*pct/100) : +(base*pct/100).toFixed(2));
        const final=(dir==='increase'? (cur==='JPY'? base+delta : +(base+delta).toFixed(2)) : (cur==='JPY'? base-delta : +(base-delta).toFixed(2)));
        return {q:`A price ${dir}s by ${pct}%. Original ${formatMoney(base,cur)} ‚Üí New price ____`, a:formatMoney(final,cur)};
      }
    }

    function listToText(list, cur){
      return list.map(p=>`${p.n}√ó${(cur==='JPY'? p.d : formatMoney(p.d,cur).replace(/^[$‚Ç¨¬£]/,''))}`).join(', ');
    }

    function combinationsForAmount(amount, cur){
      const denoms=[...currencyData[cur].denominations].sort((a,b)=>b-a);
      const combos=[];
      function greedy(target){
        let remaining=target;const picks=[];
        for(const d of denoms){
          let cnt=0;
          if(cur==='JPY'){cnt=Math.floor(remaining/d);remaining-=cnt*d;}
          else {cnt=Math.floor((remaining+1e-6)/d);remaining=+(remaining-cnt*d).toFixed(2);} 
          if(cnt>0)picks.push({d,n:cnt});
        }
        return picks;
      }
      combos.push(greedy(amount));
      if(combos[0].length>0){
        const first=JSON.parse(JSON.stringify(combos[0]));
        for(let i=0;i<first.length;i++){
          if(first[i].n>0){
            first[i].n=Math.max(0,first[i].n-1);
            let leftover=first[i].d;
            for(const d of denoms){
              if(d>=first[i].d) continue;
              let cnt=(cur==='JPY'? Math.floor(leftover/d) : Math.floor((leftover+1e-6)/d));
              if(cnt>0){
                const ex=first.find(x=>x.d===d); if(ex) ex.n+=cnt; else first.push({d,n:cnt});
                if(cur==='JPY') leftover-=cnt*d; else leftover=+(leftover-cnt*d).toFixed(2);
              }
              if(leftover<=0) break;
            }
            break;
          }
        }
        combos.push(first.filter(x=>x.n>0));
      }
      const second=JSON.parse(JSON.stringify(combos[0]||[]));
      if(second.length){
        const idx=randInt(0,second.length-1); if(second[idx].n>0){ second[idx].n--; }
        let leftover=second[idx]? second[idx].d:0;
        for(let k=denoms.length-1;k>=0;k--){
          const d=denoms[k];
          let cnt=(cur==='JPY'? Math.floor(leftover/d) : Math.floor((leftover+1e-6)/d));
          if(cnt>0){
            const ex=second.find(x=>x.d===d); if(ex) ex.n+=cnt; else second.push({d,n:cnt});
            if(cur==='JPY') leftover-=cnt*d; else leftover=+(leftover-cnt*d).toFixed(2);
          }
          if(leftover<=0) break;
        }
        combos.push(second.filter(x=>x.n>0));
      }
      return combos.map(c=>listToText(c,cur));
    }

    function populateBills(cur){
      const map={
        CAD:[5,10,20,50,100], USD:[5,10,20,50,100], EUR:[5,10,20,50,100,200], GBP:[5,10,20,50], JPY:[1000,2000,5000,10000]
      };
      const sel=document.getElementById('billGiven');
      sel.innerHTML='';
      (map[cur]||[10,20,50]).forEach(v=>{
        const opt=document.createElement('option');
        opt.value=String(v); opt.textContent=(cur==='JPY'? `¬•${v}`: `${currencyData[cur].symbol}${v}`);
        sel.appendChild(opt);
      });
    }

    function genMoney(cur, mode){
      const sumStyle = (document.getElementById('moneySumStyle')?.value) || 'target';
      const billSel=document.getElementById('billGiven');

      function randomCombo(){
        const denoms=[...currencyData[cur].denominations].sort((a,b)=>b-a);
        const picks=[]; let total=(cur==='JPY'?0:0.0);
        const count=randInt(2, Math.min(4, denoms.length));
        const chosen=[...denoms].sort(()=>Math.random()-0.5).slice(0,count);
        for(const d of chosen){
          const n=randInt(1,3);
          picks.push({d,n});
          if(cur==='JPY') total += d*n; else total = +(total + d*n).toFixed(2);
        }
        const list = listToText(picks,cur);
        return {list,total};
      }

      if(mode==='sum'){
        if(sumStyle==='coins'){
          const combo=randomCombo();
          return {q:`Coins/Bills: ${combo.list} ‚Üí Total = ____`, a:formatMoney(combo.total,cur)};
        } else {
          const amount=(cur==='JPY'? randInt(50,5000) : (randInt(1,50)+randInt(0,99)/100));
          return {q:`Count the total: ${formatMoney(amount,cur)}`, a:formatMoney(amount,cur)};
        }
      }

      if(mode==='make'){
        const amount=(cur==='JPY'? randInt(50,5000) : (randInt(1,50)+randInt(0,99)/100));
        const combos=combinationsForAmount(amount,cur);
        return {q:`Make this amount: ${formatMoney(amount,cur)}`, a:`e.g., ${combos.join(' ‚Ä¢ ')}`};
      }

      if(mode==='change'){
        const amount=(cur==='JPY'? randInt(50,5000) : (randInt(1,50)+randInt(0,99)/100));
        let bill = billSel && billSel.value ? parseFloat(billSel.value) : null;
        if(!bill){
          const standards = (cur==='JPY'? [1000,2000,5000,10000] : (cur==='EUR'? [5,10,20,50,100,200] : (cur==='GBP'? [5,10,20,50] : [5,10,20,50,100])));
          bill = standards.find(x=>x>=amount) || standards[standards.length-1];
        }
        const change=(cur==='JPY'? bill-amount : +(bill-amount).toFixed(2));
        return {q:`Change from ${formatMoney(bill,cur)} for a cost of ${formatMoney(amount,cur)}`, a:`${formatMoney(change,cur)} ‚Üí ${makeChange(change,cur)}`};
      }

      return {q:'‚Äî',a:''};
    }

    function genWord(){
      const lvl=document.getElementById('wpLevel').value;
      const em=document.getElementById('wpEmoji').value;
      const town=document.getElementById('wpTown').value.trim()||'your town';
      const prov=document.getElementById('wpProvince').value.trim()||'your province';
      const country=document.getElementById('wpCountry').value.trim()||'your country';
      const emMany = (em==='many'); const E = (a,b,c)=> em==='none'? a : (emMany? `${a} ${b} ${c}` : `${a} ${b}`);
      const nums = lvl==='easy'? [3,5,8,10] : lvl==='hard'? [24,30,45,60] : [8,12,15,20];

      const scenarios=[
        ()=>{ const n1=randInt(1,nums[2]); const n2=randInt(1,nums[1]); return {q:E('At the market in', 'üõí', 'üçé')+` ${town}, you buy ${n1} apples and ${n2} oranges. How many pieces of fruit is that?`, a:String(n1+n2)};},
        ()=>{ const mins=randInt(nums[0],nums[3]); return {q:E('You wait for the bus in', 'üöå', 'üïí')+` ${prov} for ${mins} minutes. If it arrives at 3:00, what time is it now?`, a:`${mins} min before 3:00`};},
        ()=>{ const t=randInt(8,30); return {q:E('The pool in', 'üèä', 'üå°Ô∏è')+` ${town} is ${t}¬∞C. Yesterday it was ${t-3}¬∞C. What is the change in temperature?`, a:`+3¬∞C`};},
        ()=>{ const price=randInt(2,10); const qty=randInt(2,6); return {q:E('At a snack stand in', 'üå≠', 'üíµ')+` ${country}, a hot dog is $${price}. You buy ${qty}. What is the cost before tax?`, a:`$${(price*qty).toFixed(2)}`};}
      ];
      return scenarios[randInt(0,scenarios.length-1)]();
    }

    // =========== Render ==========
    function buildAck(){
      const on=document.getElementById('wpAckToggle').checked;
      if(!on) return null;

      const sel = document.getElementById('wpNationSelect');
      const idx = sel && sel.value !== "" ? parseInt(sel.value,10) : -1;
      const terr = idx>=0 && bcNations[idx] ? bcNations[idx].nation : (document.getElementById('wpTerritory')?.value || "").trim();
      const lang = document.getElementById('wpLang').value.trim();
      const phrases=document.getElementById('wpPhrases').value.trim();

      const box=document.createElement('div'); 
      box.className='ack';

      let text = `We acknowledge that we learn on the traditional territory${terr? ' of ' + terr : ''}.`;
      if(lang) text += ` We offer respect in ${lang}.`;
      if(phrases) text += ` Phrases: ${phrases}`;
      box.textContent = text;
      return box;
    }

    function emojifyQuestion(type, q){
      const map={add:'‚ûï ', sub:'‚ûñ ', mul:'‚úñÔ∏è ', div:'‚ûó ', measure:'üìè ', time:'‚è∞ ', thermo:'üå°Ô∏è ', receipts:'üßæ ', percent:'üõçÔ∏è ', money:'üí∞ ', word:'üìù '};
      return (map[type]||'') +
