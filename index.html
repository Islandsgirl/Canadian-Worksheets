<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canadian Worksheets</title>
  <style>
    :root{
      --bg:#f8f9fa;--card:#fff;--text:#2c3e50;--muted:#666;--border:#ccd2d9;--accent:#2d7ff9;--ok:#27ae60;--warn:#ff8c00
    }
    *{box-sizing:border-box}
    body {font-family: Arial, sans-serif;margin: 2rem;background-color: var(--bg);color:var(--text)}
    h1 {color: var(--text);margin:0 0 1rem}
    h2 {margin-top: 2rem}
    label, select, input, button {display: block;margin-top: .6rem;font-size: 1rem}
    .section {padding: 1.25rem;background: var(--card);border: 1px solid var(--border);margin-bottom: 2rem;border-radius:8px}
    .row{display:flex;flex-wrap:wrap;gap:1rem}
    .col{min-width:220px;flex:1}
    .controls-inline {display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin-top:.6rem}
    .btn{background:var(--accent);color:#fff;border:0;padding:.6rem .9rem;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#6c757d}
    .btn.success{background:var(--ok)}
    .btn.ghost{background:#e9eef9;color:#1b3b88}
    .muted{color:var(--muted);font-size:.9rem}

    /* Category cards */
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid var(--border);padding:1rem;border-radius:8px}
    .card h3{margin:.2rem 0 .4rem}
    .pill{display:inline-block;background:#eef;border:1px solid #99a;padding:.1rem .45rem;border-radius:999px;font-size:.85rem;margin:.1rem .25rem 0 0}

    /* Worksheet rendering */
    .worksheet-preview {margin-top: 2rem}
    .page{page-break-after:always;border:1px solid var(--border);background:#fff;margin:0 0 1.25rem;padding:1rem;border-radius:8px}
    .page:last-child{page-break-after:auto}
    .worksheet-header {display:flex;justify-content:space-between;margin-bottom: .75rem;border-bottom:1px solid var(--border);padding-bottom:.5rem}
    .worksheet-grid {display: grid;grid-template-columns: repeat(3, 1fr);gap: .9rem;font-size: 1.12rem}
    .problem{min-height:2.4rem;border-bottom:1px dashed #ddd;padding:.2rem .25rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .decor{opacity:.95;font-size:1.1rem}
    .thumb{height:24px;width:24px;object-fit:cover;border-radius:4px;border:1px solid #ddd}
    .answer-key{margin-top:1rem;border-top:2px solid #999;padding-top:.75rem}

    footer {margin-top: 3rem;font-size: 0.9rem;color: var(--muted)}
  </style>
</head>
<body>
  <h1>üåê Canadian Worksheet Generator</h1>

  <!-- LANGUAGE ARTS (link out to reading.html) -->
  <div class="section">
    <h2>üìö Language Arts</h2>
    <p class="muted">Short, student-friendly news with multi‚Äëlevel activities.</p>
    <div class="controls-inline">
      <a class="btn secondary" href="reading.html">Open Reading Comprehension</a>
    </div>
  </div>

  <!-- MATH LANDING: user‚Äëfriendly categories -->
  <div class="section">
    <h2>‚ûó Math: Choose a Section</h2>
    <div class="grid-cards">
      <div class="card">
        <h3>Basic Operations</h3>
        <div>
          <button class="pill" data-type="add">Addition</button>
          <button class="pill" data-type="sub">Subtraction</button>
          <button class="pill" data-type="mul">Multiplication</button>
          <button class="pill" data-type="div">Division</button>
        </div>
      </div>
      <div class="card">
        <h3>Measurement</h3>
        <div>
          <button class="pill" data-type="measure">Metric Conversions</button>
          <button class="pill" data-type="time">Telling Time</button>
          <button class="pill" data-type="thermo">Thermometers</button>
        </div>
      </div>
      <div class="card">
        <h3>Money & Life Skills</h3>
        <div>
          <button class="pill" data-type="money">Money / Currency</button>
          <button class="pill" data-type="receipts">Add Receipts</button>
          <button class="pill" data-type="percent">Percent & Discounts</button>
        </div>
      </div>
    </div>
    <p class="muted" style="margin-top:.6rem">Tip: Pick a section above to auto‚Äëselect options below. Images are rights‚Äësafe by default; use your own image URLs only if you have permission.</p>
  </div>

  <!-- MATH OPTIONS -->
  <div class="section" id="mathSection">
    <h2 id="mathHeading">Worksheet Options</h2>
    <div class="row">
      <div class="col">
        <label for="mathType">Math type</label>
        <select id="mathType">
          <option value="add">Addition</option>
          <option value="sub">Subtraction</option>
          <option value="mul">Multiplication</option>
          <option value="div">Division</option>
          <option value="money">Money / Currency</option>
          <option value="measure">Measurement (metric)</option>
          <option value="time">Telling Time</option>
          <option value="thermo">Thermometer Reading</option>
          <option value="receipts">Add Receipts</option>
          <option value="percent">Percent Problems</option>
        </select>
      </div>
      <div class="col" id="numRanges">
        <label for="rangeA">Number range A (min‚Äìmax)</label>
        <input id="rangeA" type="text" value="0-20" placeholder="e.g., 0-20" />
        <span class="muted">Used by +, ‚àí, √ó, √∑</span>
        <label for="rangeB">Number range B (min‚Äìmax)</label>
        <input id="rangeB" type="text" value="0-20" placeholder="e.g., 0-20" />
      </div>
      <div class="col">
        <label for="pages">Pages</label>
        <input id="pages" type="number" min="1" max="20" value="1" />
      </div>
      <div class="col">
        <label for="perPage">Problems per page</label>
        <input id="perPage" type="number" min="6" max="60" value="24" />
      </div>
    </div>

    <!-- MONEY OPTIONS -->
    <div class="row" id="moneyRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="CAD">CAD ‚Äì $ (Canadian)</option>
          <option value="USD">USD ‚Äì $ (United States)</option>
          <option value="EUR">EUR ‚Äì ‚Ç¨ (Euro)</option>
          <option value="GBP">GBP ‚Äì ¬£ (Pound)</option>
          <option value="JPY">JPY ‚Äì ¬• (Yen)</option>
        </select>
      </div>
      <div class="col">
        <label for="moneyMode">Money problem type</label>
        <select id="moneyMode">
          <option value="sum">Count the total value</option>
          <option value="make">Make this amount</option>
          <option value="change">Change from amount</option>
        </select>
      </div>
    </div>

    <!-- TIME OPTIONS -->
    <div class="row" id="timeRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="timeFormat">Time format</label>
        <select id="timeFormat">
          <option value="digital">Digital (HH:MM)</option>
          <option value="analog">Analog (describe clock)</option>
        </select>
      </div>
      <div class="col">
        <label for="timeStep">Minute steps</label>
        <select id="timeStep">
          <option value="5">5 minutes</option>
          <option value="1">1 minute</option>
          <option value="15">15 minutes</option>
        </select>
      </div>
      <div class="col">
        <label for="timeSystem">Clock</label>
        <select id="timeSystem">
          <option value="12">12‚Äëhour</option>
          <option value="24">24‚Äëhour</option>
        </select>
      </div>
    </div>

    <!-- THERMOMETER OPTIONS -->
    <div class="row" id="thermoRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="tempScale">Temperature scale</label>
        <select id="tempScale">
          <option value="C">Celsius (¬∞C)</option>
          <option value="F">Fahrenheit (¬∞F)</option>
        </select>
      </div>
    </div>

    <!-- RECEIPTS OPTIONS -->
    <div class="row" id="receiptsRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="itemsCount">Items per receipt</label>
        <input id="itemsCount" type="number" min="2" max="8" value="4" />
      </div>
      <div class="col">
        <label for="taxPct">Sales tax %</label>
        <input id="taxPct" type="number" min="0" max="25" value="5" />
        <span class="muted">Set to 0 for no tax</span>
      </div>
    </div>

    <!-- PERCENT OPTIONS -->
    <div class="row" id="percentRow" style="margin-top:.5rem;display:none;">
      <div class="col">
        <label for="percentKind">Percent scenario</label>
        <select id="percentKind">
          <option value="discount">Store discount</option>
          <option value="tip">Restaurant tip</option>
          <option value="tax">Sales tax</option>
          <option value="change">Increase / Decrease</option>
        </select>
      </div>
    </div>

    <!-- DECOR OPTIONS -->
    <div class="row" style="margin-top:.5rem;">
      <div class="col">
        <label for="emojiTheme">Emoji theme (decorations)</label>
        <select id="emojiTheme">
          <option value="none">None</option>
          <option value="animals">Animals üêæ</option>
          <option value="space">Space üöÄ</option>
          <option value="sports">Sports üèà</option>
          <option value="food">Food üçé</option>
        </select>
      </div>
      <div class="col">
        <label for="imageTheme">Image theme (safe)</label>
        <select id="imageTheme">
          <option value="none">None</option>
          <option value="public_domain">Public‚Äëdomain icons</option>
        </select>
        <span class="muted">Avoid copyrighted characters. Use your own images only if you have rights.</span>
      </div>
      <div class="col">
        <label for="customImg">Custom image URL (optional)</label>
        <input id="customImg" type="text" placeholder="https://‚Ä¶ (must have usage rights)" />
      </div>
    </div>

    <div class="controls-inline">
      <label><input type="checkbox" id="showAnswers"/> Show Answer Key</label>
      <button class="btn" id="btnGenerate">Generate Worksheet</button>
      <button class="btn success" id="btnPrint">Print / Save PDF</button>
      <button class="btn secondary" id="btnSelfTest" title="Run quick checks">Run Self‚ÄëTest</button>
    </div>
  </div>

  <div class="worksheet-preview" id="worksheet"></div>

  <div id="status" class="section" style="display:none; border-color:#f3c7c7; background:#fff7f7">
    <strong>Status:</strong>
    <pre id="statusText" style="white-space:pre-wrap;margin:.5rem 0 0"></pre>
  </div>

  <footer>
    <h2>Privacy Policy</h2>
    <p>This website may use cookies for basic functionality. We do not collect personally identifiable information unless you choose to provide it. We will never sell your data to third parties.</p>
    <p class="muted">Image use note: Do not upload or embed copyrighted character images unless you own or have permission to use them.</p>
  </footer>

  <script>
    // =========== Helpers ==========
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const parseRange=(s,def=[0,20])=>{const m=(s||"").trim().match(/^(\-?\d+)\s*[-‚Äì]\s*(\-?\d+)$/);if(!m)return def.map(Number);const a=parseInt(m[1],10),b=parseInt(m[2],10);return a<=b?[a,b]:[b,a]};

    const emojiPacks={
      none:[],
      animals:["ü¶ä","üêª","üê±","üê∂","ü¶â","üê∞"],
      space:["üöÄ","üõ∞Ô∏è","ü™ê","üåå","üõ∏","üåü"],
      sports:["‚öΩ","üèÄ","üèà","üéæ","üèí","ü•ã"],
      food:["üçé","üçî","üçï","üç£","üç™","üçâ"]
    };

    const pdThumbs=[
      "https://upload.wikimedia.org/wikipedia/commons/3/3f/Transparent_pixel.png"
    ];

    const currencyData={
      CAD:{symbol:"$", code:"CAD", denominations:[100,25,10,5,1,0.25,0.10,0.05]},
      USD:{symbol:"$", code:"USD", denominations:[100,50,20,10,5,1,0.25,0.10,0.05]},
      EUR:{symbol:"‚Ç¨", code:"EUR", denominations:[100,50,20,10,5,2,1,0.5,0.2,0.1]},
      GBP:{symbol:"¬£", code:"GBP", denominations:[50,20,10,5,2,1,0.5,0.2,0.1]},
      JPY:{symbol:"¬•", code:"JPY", denominations:[10000,5000,2000,1000,500,100,50,10,5,1]}
    };

    function formatMoney(val, cur){
      if(cur==="JPY") return `¬•${Math.round(val)}`;
      return `${currencyData[cur].symbol}${val.toFixed(2)}`;
    }

    function makeChange(amount, cur){
      const denoms=[...currencyData[cur].denominations].sort((a,b)=>b-a);
      let remaining=amount;const out=[];
      for(const d of denoms){
        let cnt=0;
        if(cur==="JPY"){cnt=Math.floor(remaining/d);remaining-=cnt*d;}
        else {cnt=Math.floor((remaining+1e-6)/d);remaining=+(remaining-cnt*d).toFixed(2);} 
        if(cnt>0) out.push(`${cnt}√ó${(cur==="JPY"? d: formatMoney(d,cur).replace(/^[$‚Ç¨¬£]/,''))}`);
      }
      return out.join(", ");
    }

    function pickDecor(){
      const emTheme=document.getElementById('emojiTheme').value;
      const arr=emojiPacks[emTheme]||[];const em=arr.length?arr[randInt(0,arr.length-1)]:"";
      const imgTheme=document.getElementById('imageTheme').value;
      const custom=document.getElementById('customImg').value.trim();
      let imgSrc="";
      if(custom) imgSrc=custom; else if(imgTheme==='public_domain') imgSrc=pdThumbs[0];
      return {em,imgSrc};
    }

    // =========== Problem generators ==========
    function genArithmetic(op,aRange,bRange){
      const [aMin,aMax]=parseRange(aRange);const [bMin,bMax]=parseRange(bRange);
      const a=randInt(aMin,aMax), b=randInt(bMin,bMax);
      switch(op){
        case 'add': return {q:`${a} + ${b} = ____`, a:(a+b)};
        case 'sub': return {q:`${a} ‚àí ${b} = ____`, a:(a-b)};
        case 'mul': return {q:`${a} √ó ${b} = ____`, a:(a*b)};
        case 'div': {
          const x=randInt(aMin,aMax), y=randInt(Math.max(1,bMin),Math.max(1,bMax));
          return {q:`${x*y} √∑ ${y} = ____`, a:x};
        }
      }
    }

    function genMeasurement(){
      const types=["cm‚Üím","m‚Üícm","g‚Üíkg","kg‚Üíg","mL‚ÜíL","L‚ÜímL"];
      const t=types[randInt(0,types.length-1)];
      switch(t){
        case "cm‚Üím":{const v=randInt(10,5000);return {q:`Convert ${v} cm to m`, a:(v/100).toFixed(2)+" m"}};
        case "m‚Üícm":{const v=randInt(1,500);return {q:`Convert ${v} m to cm`, a:(v*100)+" cm"}};
        case "g‚Üíkg":{const v=randInt(100,50000);return {q:`Convert ${v} g to kg`, a:(v/1000).toFixed(2)+" kg"}};
        case "kg‚Üíg":{const v=randInt(1,200);return {q:`Convert ${v} kg to g`, a:(v*1000)+" g"}};
        case "mL‚ÜíL":{const v=randInt(100,5000);return {q:`Convert ${v} mL to L`, a:(v/1000).toFixed(2)+" L"}};
        case "L‚ÜímL":{const v=randInt(1,10);return {q:`Convert ${v} L to mL`, a:(v*1000)+" mL"}};
      }
    }

    function genTime(){
      const step=parseInt(document.getElementById('timeStep').value)||5;
      const system=document.getElementById('timeSystem').value; // '12' or '24'
      const fmt=document.getElementById('timeFormat').value; // 'digital' | 'analog'
      const totalMinutes=randInt(0, Math.floor(24*60/step))*step;
      let h=Math.floor(totalMinutes/60), m=totalMinutes%60;
      let label;
      if(system==='12'){
        const ampm=h>=12? 'PM':'AM';
        const hh=((h%12)||12).toString().padStart(2,'0');
        label=`${hh}:${m.toString().padStart(2,'0')} ${ampm}`;
      } else { label=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }
      if(fmt==='digital') return {q:`What time is this? ${label.replace(/\s?(AM|PM)/,'')}`, a:label};
      // analog description to avoid needing images
      const hourPos=(h%12)+(m/60);
      const minutePos=m/5; // 12 ticks
      return {q:`Analog clock: hour hand near ${Math.round(hourPos)}; minute hand on ${minutePos*5} minutes. What time is it?`, a:label};
    }

    function genThermo(){
      const scale=document.getElementById('tempScale').value; // C or F
      // choose classroom-friendly temps
      const val=(scale==='C')? randInt(-10,40) : randInt(10,105);
      return {q:`Thermometer reads: ${val} ¬∞${scale}. Write the temperature.`, a:`${val}¬∞${scale}`};
    }

    function genReceipts(){
      const cur=document.getElementById('currency').value || 'CAD';
      const items=parseInt(document.getElementById('itemsCount').value)||4;
      const tax=parseFloat(document.getElementById('taxPct').value)||0;
      const names=["Apples","Milk","Bread","Pasta","Soup","Bananas","Notebook","Markers","Yogurt","Juice"];
      let total=0;const lines=[];
      for(let i=0;i<items;i++){
        const name=names[randInt(0,names.length-1)];
        const price=(cur==='JPY'? randInt(50,900) : (randInt(1,120)+randInt(0,99)/100));
        lines.push(`${name} ‚Äî ${formatMoney(price,cur)}`);
        total += price;
      }
      const taxAmt = (cur==='JPY'? Math.round(total*tax/100) : +(total*tax/100).toFixed(2));
      const grand = (cur==='JPY'? Math.round(total+taxAmt) : +(total+taxAmt).toFixed(2));
      return {q:`üßæ Receipt: ${lines.join('; ')}; Tax ${tax}% ‚Üí Total = ____`, a:formatMoney(grand,cur)};
    }

    function genPercent(){
      const cur=document.getElementById('currency').value || 'CAD';
      const kind=document.getElementById('percentKind').value; // discount/tip/tax/change
      if(kind==='discount'){
        const price=(cur==='JPY'? randInt(500,6000) : (randInt(5,80)+randInt(0,99)/100));
        const pct=[10,15,20,25,30][randInt(0,4)];
        const disc=(cur==='JPY'? Math.round(price*pct/100) : +(price*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(price-disc) : +(price-disc).toFixed(2));
        return {q:`Store sale: ${pct}% off ${formatMoney(price,cur)} ‚Üí Pay ____`, a:formatMoney(final,cur)};
      } else if(kind==='tip'){
        const bill=(cur==='JPY'? randInt(800,8000) : (randInt(10,120)+randInt(0,99)/100));
        const pct=[10,12,15,18,20][randInt(0,4)];
        const tipAmt=(cur==='JPY'? Math.round(bill*pct/100) : +(bill*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(bill+tipAmt) : +(bill+tipAmt).toFixed(2));
        return {q:`Restaurant bill ${formatMoney(bill,cur)} + tip ${pct}% = ____`, a:formatMoney(final,cur)};
      } else if(kind==='tax'){
        const price=(cur==='JPY'? randInt(300,9000) : (randInt(5,100)+randInt(0,99)/100));
        const pct=[5,8,10,12][randInt(0,3)];
        const taxAmt=(cur==='JPY'? Math.round(price*pct/100) : +(price*pct/100).toFixed(2));
        const final=(cur==='JPY'? Math.round(price+taxAmt) : +(price+taxAmt).toFixed(2));
        return {q:`Item ${formatMoney(price,cur)} + tax ${pct}% = ____`, a:formatMoney(final,cur)};
      } else { // change
        const base=(cur==='JPY'? randInt(500,5000) : (randInt(10,200)+randInt(0,99)/100));
        const pct=[5,10,20,25,30][randInt(0,4)];
        const dir=Math.random()<0.5? 'increase':'decrease';
        const delta=(cur==='JPY'? Math.round(base*pct/100) : +(base*pct/100).toFixed(2));
        const final=(dir==='increase'? (cur==='JPY'? base+delta : +(base+delta).toFixed(2)) : (cur==='JPY'? base-delta : +(base-delta).toFixed(2)));
        return {q:`A price ${dir}s by ${pct}%. Original ${formatMoney(base,cur)} ‚Üí New price ____`, a:formatMoney(final,cur)};
      }
    }

    // *** FIX: define genMoney (was missing) ***
    function genMoney(cur, mode){
      // cur is one of CAD, USD, EUR, GBP, JPY
      // mode: 'sum' | 'make' | 'change'
      if(cur==='JPY'){
        const amount=randInt(50,5000); // whole yen
        if(mode==='sum') return {q:`Count the total: ${formatMoney(amount,cur)}`, a:formatMoney(amount,cur)};
        if(mode==='make') return {q:`Make this amount: ${formatMoney(amount,cur)}`, a:makeChange(amount,cur)};
        // change
        const paid=[1000,2000,5000,10000][randInt(0,3)];
        const change=paid-amount;return {q:`Change from ${formatMoney(paid,cur)} for a cost of ${formatMoney(amount,cur)}`, a:formatMoney(change,cur)};
      } else {
        const amount=(randInt(1,50)+randInt(0,99)/100); // up to ~$50.xx
        if(mode==='sum') return {q:`Count the total: ${formatMoney(amount,cur)}`, a:formatMoney(amount,cur)};
        if(mode==='make') return {q:`Make this amount: ${formatMoney(amount,cur)}`, a:makeChange(amount,cur)};
        const paid=[5,10,20,50,100][randInt(0,4)];
        const change=+(paid-amount).toFixed(2);
        return {q:`Change from ${formatMoney(paid,cur)} for a cost of ${formatMoney(amount,cur)}`, a:formatMoney(change,cur)};
      }
    }

    // =========== Render ==========
    function buildPage({pageNum,problems,decor}){
      const page=document.createElement('div');page.className='page';
      page.innerHTML=`<div class="worksheet-header">
        <div>Name: __________________</div>
        <div>Page ${pageNum}</div>
        <div>Date: __________</div>
      </div>
      <div class="worksheet-grid"></div>`;
      const grid=page.querySelector('.worksheet-grid');
      for(const p of problems){
        const row=document.createElement('div');row.className='problem';
        const left=document.createElement('div');left.textContent=p.q;
        const right=document.createElement('div');right.className='decor';
        if(decor.em) right.textContent=decor.em;
        if(decor.imgSrc){const img=new Image();img.src=decor.imgSrc;img.alt='';img.className='thumb';right.appendChild(img);} 
        row.appendChild(left);row.appendChild(right);grid.appendChild(row);
      }
      return page;
    }

    function generate(){
      const showStatus=(msg)=>{const box=document.getElementById('status');const t=document.getElementById('statusText');t.textContent=msg;box.style.display='block'};
      try{
        const mathType=document.getElementById('mathType').value;
        const pages=Math.max(1,parseInt(document.getElementById('pages').value)||1);
        const perPage=Math.max(1,parseInt(document.getElementById('perPage').value)||24);
        const showAnswers=document.getElementById('showAnswers').checked;
        const aRange=document.getElementById('rangeA').value;
        const bRange=document.getElementById('rangeB').value;
        const decor=pickDecor();

        const ws=document.getElementById('worksheet');
        ws.innerHTML='';
        const allAnswers=[];

        for(let pg=1;pg<=pages;pg++){
          const problems=[];
          for(let i=0;i<perPage;i++){
            let item;
            if(['add','sub','mul','div'].includes(mathType)) item=genArithmetic(mathType,aRange,bRange);
            else if(mathType==='measure') item=genMeasurement();
            else if(mathType==='money'){
              const cur=(document.getElementById('currency')||{value:'CAD'}).value;
              const mode=(document.getElementById('moneyMode')||{value:'sum'}).value;
              item=genMoney(cur,mode);
            } else if(mathType==='time') item=genTime();
            else if(mathType==='thermo') item=genThermo();
            else if(mathType==='receipts') item=genReceipts();
            else if(mathType==='percent') item=genPercent();
            else { item={q:'‚Äî',a:''}; }
            if(!item||!item.q){ item={q:'(no question generated)', a:''}; }
            problems.push(item); allAnswers.push(item.a);
          }
          ws.appendChild(buildPage({pageNum:pg,problems,decor}));
        }

        if(showAnswers){
          const key=document.createElement('div');key.className='answer-key';
          key.innerHTML='<h3>Answer Key</h3>';
          const ol=document.createElement('ol');
          allAnswers.forEach(a=>{const li=document.createElement('li');li.textContent=(a!==undefined&&a!==null)?String(a):'';ol.appendChild(li)});
          key.appendChild(ol);ws.appendChild(key);
        }
        showStatus(`Generated ${pages} page(s) √ó ${perPage} problems (${mathType}).`);
      } catch(err){
        console.error(err);
        alert('Oops‚Äîsomething went wrong. See the Status panel for details.');
        const msg = (err && err.stack) ? err.stack : String(err);
        const box=document.getElementById('status');const t=document.getElementById('statusText');t.textContent=msg;box.style.display='block';
      }
    } else if(mathType==='time') item=genTime();
          else if(mathType==='thermo') item=genThermo();
          else if(mathType==='receipts') item=genReceipts();
          else if(mathType==='percent') item=genPercent();
          else { item={q:'‚Äî',a:''}; }
          problems.push(item); allAnswers.push(item.a);
        }
        ws.appendChild(buildPage({pageNum:pg,problems,decor}));
      }

      if(showAnswers){
        const key=document.createElement('div');key.className='answer-key';
        key.innerHTML='<h3>Answer Key</h3>';
        const ol=document.createElement('ol');
        allAnswers.forEach(a=>{const li=document.createElement('li');li.textContent=(a!==undefined&&a!==null)?String(a):'';ol.appendChild(li)});
        key.appendChild(ol);ws.appendChild(key);
      }
    }

    // =========== UI wiring ==========
    // Category pills
    document.querySelectorAll('.pill').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const type=btn.getAttribute('data-type');
        document.getElementById('mathType').value=type;
        refreshOptionVisibility();
        window.scrollTo({top:document.getElementById('mathSection').offsetTop-10, behavior:'smooth'});
      });
    });

    function refreshOptionVisibility(){
      const val=document.getElementById('mathType').value;
      document.getElementById('moneyRow').style.display = (val==='money' || val==='receipts' || val==='percent') ? 'flex' : 'none';
      document.getElementById('timeRow').style.display = (val==='time') ? 'flex' : 'none';
      document.getElementById('thermoRow').style.display = (val==='thermo') ? 'flex' : 'none';
      document.getElementById('receiptsRow').style.display = (val==='receipts') ? 'flex' : 'none';
      document.getElementById('percentRow').style.display = (val==='percent') ? 'flex' : 'none';
      document.getElementById('numRanges').style.display = (['add','sub','mul','div'].includes(val))? 'block' : 'none';
      document.getElementById('mathHeading').textContent = `Worksheet Options ‚Äî ${val}`;
    }

    document.getElementById('mathType').addEventListener('change',refreshOptionVisibility);
    document.getElementById('btnGenerate').addEventListener('click',generate);
    document.getElementById('btnPrint').addEventListener('click',()=>window.print());

    // Self‚Äëtest (existing tests preserved) + new money test
    document.getElementById('btnSelfTest').addEventListener('click',()=>{
      console.clear();
      console.log('‚Äî Self‚ÄëTest start ‚Äî');
      console.assert(JSON.stringify(parseRange('0-10'))===JSON.stringify([0,10]),'parseRange basic');
      console.assert(JSON.stringify(parseRange('10-0'))===JSON.stringify([0,10]),'parseRange order');
      console.assert(typeof genArithmetic('add','0-5','0-5').a==='number','arithmetic answer number');
      console.assert(typeof genMeasurement().q==='string','measurement question string');
      console.assert(typeof genTime().a==='string','time answer');
      console.assert(typeof genThermo().a==='string','thermo answer');
      console.assert(typeof genReceipts().a==='string','receipts answer');
      console.assert(typeof genPercent().a==='string','percent answer');
      console.assert(typeof genMoney('CAD','sum').a==='string','money answer');
      console.assert(formatMoney(3.5,'CAD')==='$3.50','CAD format');
      console.assert(formatMoney(3500,'JPY').startsWith('¬•'),'JPY format');
      console.assert(makeChange(4.75,'USD').length>0,'change maker');
      console.log('‚Äî Self‚ÄëTest complete ‚Äî');
      alert('Self‚ÄëTest complete. Open console for details.');
    });

    // Initialize
    refreshOptionVisibility();

    // Global error trap so silent errors show up in the Status box
    window.addEventListener('error', (e)=>{
      const box=document.getElementById('status');const t=document.getElementById('statusText');
      t.textContent = `Runtime error: ${e.message}
` + (e.error && e.error.stack ? e.error.stack : '');
      box.style.display='block';
    });
  </script>
</body>
</html>

